from dotenv import load_dotenv
load_dotenv()

import os
import streamlit as st
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage

# ------------ .env èª­ã¿è¾¼ã¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/Cloudã§æ—¢ã«ã‚»ãƒƒãƒˆæ¸ˆã¿ãªã‚‰ãã®ã¾ã¾ä¸Šæ›¸ãï¼‰ ------------
load_dotenv()

# å¿…é ˆ: OPENAI_API_KEY / ä»»æ„: OPENAI_MODEL
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "")
MODEL_NAME = os.getenv("OPENAI_MODEL", "gpt-4o-mini")

# ------------ ç”»é¢åŸºæœ¬ ------------
st.set_page_config(page_title="LLMæ–‡ç« ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆãƒªãƒ©ã‚¤ãƒˆ/è¦ç´„ï¼‰", page_icon="âœï¸")
st.title("âœï¸ LLMæ–‡ç« ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆãƒªãƒ©ã‚¤ãƒˆ/è¦ç´„ï¼‰")
st.caption("å…¥åŠ›ã—ãŸæ–‡ç« ã‚’ã€A: èª­ã¿ã‚„ã™ããƒªãƒ©ã‚¤ãƒˆ / B: ç®‡æ¡æ›¸ãã§è¦ç´„ã€‚A/Bã‚’é¸ã³ã€å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")

with st.expander("â„¹ï¸ ã‚¢ãƒ—ãƒªæ¦‚è¦ãƒ»æ“ä½œæ–¹æ³•", expanded=True):
    st.markdown(
        """
**ã§ãã‚‹ã“ã¨**  
- å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚‚ã¨ã«ã€**A=ãƒ—ãƒ­ã®UXãƒ©ã‚¤ã‚¿ãƒ¼**ï¼ˆèª­ã¿ã‚„ã™ã•é‡è¦–ã®ãƒªãƒ©ã‚¤ãƒˆï¼‰ã¾ãŸã¯  
  **B=ãƒ—ãƒ­ã®è¦ç´„è€…**ï¼ˆæ§‹é€ åŒ–ã•ã‚ŒãŸç®‡æ¡æ›¸ãè¦ç´„ï¼‰ã¨ã—ã¦ LLM ãŒå¿œç­”ã—ã¾ã™ã€‚

**ä½¿ã„æ–¹**  
1.ä¸‹ã®ãƒ©ã‚¸ã‚ªã§ **A/B** ã‚’é¸æŠã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ› â†’ **å®Ÿè¡Œ**

> æ³¨æ„ï¼šç”Ÿæˆçµæœã¯å‚è€ƒã‚¬ã‚¤ãƒ‰ã§ã™ã€‚æ•°å€¤ãƒ»å›ºæœ‰åè©ã¯åŸå…¸ã§ã”ç¢ºèªãã ã•ã„ã€‚
        """
    )

# ------------ ãƒ©ã‚¸ã‚ªï¼ˆA/Bï¼‰------------
expert_choice = st.radio(
    "å°‚é–€å®¶ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠï¼ˆA/Bï¼‰",
    options=["A", "B"],  # è¦ä»¶ã©ãŠã‚Š A/B ã®ã¿
    horizontal=True,
    help="A=ãƒ—ãƒ­ã®UXãƒ©ã‚¤ã‚¿ãƒ¼ï¼ˆèª­ã¿ã‚„ã™ããƒªãƒ©ã‚¤ãƒˆï¼‰ / B=ãƒ—ãƒ­ã®è¦ç´„è€…ï¼ˆç®‡æ¡æ›¸ãè¦ç´„ï¼‰",
)
st.caption("Aï¼šæ˜ç¢ºãƒ»ç°¡æ½”ã«ãƒªãƒ©ã‚¤ãƒˆ / Bï¼šä¸»è¦ç‚¹ã®æŠ½å‡ºã¨æ§‹é€ åŒ–ï¼ˆç®‡æ¡æ›¸ãï¼‰")

# ------------ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆ1ã¤ï¼‰------------
user_text = st.text_area(
    "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¸‹æ›¸ãã€è­°äº‹éŒ²ã€é•·æ–‡ãƒ¡ãƒ¢ãªã©ï¼‰",
    height=180,
    placeholder="ä¾‹ï¼šå…ˆæ—¥ã®ä¼šè­°ã§ã¯æ–°æ©Ÿèƒ½ã®å„ªå…ˆé †ä½ã«ã¤ã„ã¦è­°è«–ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã®å¤šã„Aæ©Ÿèƒ½ã‚’å…ˆã«å‡ºã™ã‹ã€åç›Šæ€§ã®é«˜ã„Bæ©Ÿèƒ½ã‚’å…ˆã«ã™ã‚‹ã‹ã§æ„è¦‹ãŒåˆ†ã‹ã‚ŒãŸâ€¦",
)

# ------------ LLMå‘¼ã³å‡ºã—é–¢æ•°ï¼ˆè¦ä»¶ï¼šå…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼‹ãƒ©ã‚¸ã‚ªé¸æŠã‚’å—ã‘å–ã‚Šã€å›ç­”æ–‡å­—åˆ—ã‚’è¿”ã™ï¼‰------------
def ask_llm(input_text: str, expert_choice: str) -> str:
    """
    Parameters
    ----------
    input_text : str
        ç”»é¢ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
    expert_choice : str
        "A" ã¾ãŸã¯ "B"ï¼ˆãƒ©ã‚¸ã‚ªé¸æŠå€¤ï¼‰
    Returns
    -------
    str
        LLMã®å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ
    """
    if not OPENAI_API_KEY:
        raise RuntimeError("OPENAI_API_KEY ãŒæœªè¨­å®šã§ã™ã€‚.env ã«è¨­å®šã—ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")

    if expert_choice == "A":
        system_prompt = (
            "ã‚ãªãŸã¯ãƒ—ãƒ­ã®UXãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚èª­ã¿ã‚„ã™ã•ãƒ»ç°¡æ½”ã•ãƒ»æ­£ç¢ºã•ã‚’é‡è¦–ã—ã€"
            "å°‚é–€ç”¨èªã«ã¯è£œè¶³ã‚’åŠ ãˆã€å†—é•·ã‚„æ›–æ˜§ã•ã‚’é¿ã‘ã¦ãƒªãƒ©ã‚¤ãƒˆã—ã¦ãã ã•ã„ã€‚"
            "å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š\n"
            "1) è¦‹å‡ºã—ï¼ˆçŸ­ãå…·ä½“çš„ã«ï¼‰\n"
            "2) æœ¬æ–‡ï¼ˆ3ã€œ8æ–‡ã€æ®µè½å¯ï¼‰\n"
            "3) è¿½è¨˜ï¼ˆé‡è¦ãªæ³¨æ„ãƒ»å‰æãŒã‚ã‚Œã°1ã€œ2è¡Œï¼‰"
        )
    else:
        system_prompt = (
            "ã‚ãªãŸã¯ãƒ—ãƒ­ã®è¦ç´„è€…ã§ã™ã€‚é‡è¦ç‚¹ã®æŠ½å‡ºãƒ»éšå±¤åŒ–ãƒ»é‡è¤‡ã®æ’é™¤ã‚’è¡Œã„ã€"
            "ç°¡æ½”ãªç®‡æ¡æ›¸ãã§æç¤ºã—ã¦ãã ã•ã„ã€‚"
            "å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š\n"
            "- ç›®çš„/èƒŒæ™¯\n"
            "- ä¸»è¦ãªè«–ç‚¹ï¼ˆ3ã€œ6ç‚¹ï¼‰\n"
            "- æ±ºå®šäº‹é …/æœªæ±ºäº‹é …\n"
            "- æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ‹…å½“/æœŸé™ãŒã‚ã‚Œã°ä»˜ä¸ï¼‰"
        )

    llm = ChatOpenAI(model=MODEL_NAME, temperature=0.4, api_key=OPENAI_API_KEY)
    messages = [SystemMessage(content=system_prompt), HumanMessage(content=input_text)]
    resp = llm.invoke(messages)
    return resp.content

# ------------ å®Ÿè¡Œ ------------
if st.button("å®Ÿè¡Œ", type="primary"):
    st.divider()
    if not user_text.strip():
        st.error("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        try:
            answer = ask_llm(user_text, expert_choice)
            st.subheader("ğŸ§¾ çµæœ")
            st.write(answer)
        except Exception as e:
            st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š{e}")
